<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" class="no-js">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta name="keywords" content="HaI,HaI丶Picture,Hai,Hal,个人相册,在线相册" />
        <meta name="description" content="HaI丶Picture是一个基于七牛云OSS搭建的个人相册，可在线预览多张图片" />
        <title>HaI丶Picture</title>
        <link rel="icon" type="image/x-icon" href="logo.ico" />
        <link rel="stylesheet" href="baguettebox.min.css"/>
        <link rel="stylesheet" href="style.css"/>
        <script src="jquery-3.1.1.min.js"></script>
        <script src="jquery.cookie.js"></script>
        <script src="baguettebox.min.js"></script>
        <script src="modernizr.custom.js"></script>
    </head>
    <body>
        <div id="app">
        <div class="page parallel">
            <div class="d-flex row">
                <div class="col-md-12  height-full accent-3 align-self-center text-center" data-bg-repeat="false"
                     data-bg-possition="center">
                    <video  id="video" autoplay style="width:100%;height:100%;opacity: 1"></video>
                    <!--描绘video截图-->
                    <canvas style="display: none;" id="canvas" width="480" height="320"></canvas>
                </div>
            </div>
        </div>
        <!-- /.right-sidebar -->
        <!-- Add the sidebar's background. This div must be placed
                 immediately after the control sidebar -->
        </div>
        <!--/#app -->
       
        <div class="container">
          <svg class="bike" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 509.88 346.42">
            <title>自行车加载器</title>
            <text class="loading" x="140" y="50">LOADING...</text>
            <circle cx="381.99" cy="217.27" r="57" fill="none"/>
            <rect x="205.49" y="100.77" width="130" height="10" fill="#ffffff" stroke="#ffffff" stroke-miterlimit="10"/>
            <rect x="335.99" y="59.27" width="10" height="58.84" fill="#ffffff" stroke="#ffffff" stroke-miterlimit="10"/>
            <rect x="687.32" y="367.76" width="9.47" height="129.52" transform="translate(32.95 -610.41) rotate(39.23)" fill="#ffffff" stroke="#ffffff" stroke-miterlimit="10"/>
            <rect x="615.67" y="333.48" width="9.89" height="150.8" transform="translate(-499.92 -29.09) rotate(-20.33)" fill="#ffffff" stroke="#ffffff" stroke-miterlimit="10"/>
            <rect x="346.9" y="59.27" width="36.97" height="10" fill="#2a2d2c" stroke="#2a2d2c" stroke-miterlimit="10"/>
            <path d="M779.38,329a30.2,30.2,0,0,1,17.28,6.85,22.87,22.87,0,0,1,5.81,7.44,18.46,18.46,0,0,1,1.81,9.24,17.69,17.69,0,0,1-3,8.57A20.36,20.36,0,0,1,795,367a25.93,25.93,0,0,1-15.65,3.57,24.5,24.5,0,0,0,14-5.78,17,17,0,0,0,4.28-5.73,12.81,12.81,0,0,0,1.1-6.53,13.55,13.55,0,0,0-7-10A20.68,20.68,0,0,0,779.38,340Z" transform="translate(-396.51 -270.23)" fill="#2a2d2c"/>
            <rect id="seat" x="165.99" y="58.27" width="63.01" height="10" fill="#2a2d2c" stroke="#2a2d2c" stroke-miterlimit="10"/>
            <g id="back-wheel">
              <circle id="wheel" cx="130.99" cy="217.27" r="80" fill="none" stroke="#2a2d2c" stroke-miterlimit="10" stroke-width="6"/>
              <circle id="wheel-ring" cx="130.99" cy="217.27" r="76" fill="none" stroke="#9ab0a6" stroke-miterlimit="10" stroke-width="3"/>
              <circle id="wheel-center" cx="130.99" cy="217.27" r="9.64" fill="#2a2d2c" stroke="#2a2d2c" stroke-miterlimit="10"/>
              <g id="back-light">
                <rect x="116.32" y="156.9" width="28.67" height="9.57" rx="4.79" fill="#fff"/>
                <rect x="117.32" y="266.9" width="28.67" height="9.57" rx="4.79" fill="#fff" stroke="#fff" stroke-miterlimit="10"/>
              </g>
            </g>
            <g id="center">
              <circle id="center-2" data-name="center" cx="251.49" cy="211.77" r="22" fill="#9edac0" stroke="#2a2d2c" stroke-miterlimit="10" stroke-width="2"/>
              <circle id="center-3" data-name="center" cx="251.49" cy="211.77" r="17" fill="#9edac0" stroke="#2a2d2c" stroke-miterlimit="10" stroke-width="2"/>
              <circle id="center-4" data-name="center" cx="251.49" cy="211.77" r="12" fill="#9edac0" stroke="#2a2d2c" stroke-miterlimit="10" stroke-width="2"/>
              <circle id="center-5" data-name="center" cx="251.49" cy="211.77" r="7" fill="#9edac0" stroke="#2a2d2c" stroke-miterlimit="10" stroke-width="2"/>
            </g>
            <g id="front-wheel" data-name="front-wheel">
              <circle id="wheel-2" data-name="wheel" cx="383.99" cy="217.27" r="80" fill="none" stroke="#2a2d2c" stroke-miterlimit="10" stroke-width="6"/>
              <circle id="wheel-ring-2" data-name="wheel-ring" cx="383.99" cy="217.27" r="76" fill="none" stroke="#9ab0a6" stroke-miterlimit="10" stroke-width="3"/>
              <circle id="wheel-center-2" data-name="wheel-center" cx="383.99" cy="217.27" r="9.64" fill="#2a2d2c" stroke="#2a2d2c" stroke-miterlimit="10"/>
              <g id="front-light" data-name="front-light">
                <rect x="369.32" y="156.9" width="28.67" height="9.57" rx="4.79" fill="#fff"/>
                <rect x="370.32" y="266.9" width="28.67" height="9.57" rx="4.79" fill="#fff" stroke="#fff" stroke-miterlimit="10"/>
              </g>
            </g>
            <rect x="752.93" y="376.48" width="10.69" height="107.09" transform="translate(-502.34 44.78) rotate(-21.98)" fill="#ffffff" stroke="#ffffff" stroke-miterlimit="10"/>
            <rect x="563.96" y="358.94" width="9.86" height="132.52" transform="translate(-62.18 -515.41) rotate(33.94)" fill="#ffffff" stroke="#ffffff" stroke-miterlimit="10"/>
          </svg>
        </div>
        <script src='TweenMax.min.js'></script> 
        <script src="script.js"></script>

        <div id="gallery" class="baguetteBoxOne gallery effect-1"> 
        </div>
        <button id="return_top" class="baguetteBox-button">
            <svg width="60" height="44"><polyline points="50 30 30 10 10 30" stroke="rgba(255,255,255,0.5)" stroke-width="4" stroke-linecap="butt" fill="none" stroke-linejoin="round"></polyline></svg>
        </button>
        <div style="text-align:center;margin:50px 0; font:normal 14px/24px 'MicroSoft YaHei';">
        <p>Powered by Qiniu and Theme by Baguettebox & AnimOnScroll © 2019 HaI</p>

        <script src="masonry.pkgd.min.js"></script> 
        <script src="imagesloaded.js"></script> 
        <script src="classie.js"></script> 
        <script src="AnimOnScroll.js"></script>
        <script type="text/javascript">
            //滚动超过一屏幕应该显示，否则消失
            var pagelookheight = document.documentElement.clientHeight;
            $(function () {
                $(window).scroll(function(){
                    if ($(window).scrollTop()>pagelookheight){
                        $("#return_top").fadeIn(500);
                    }else{
                        $("#return_top").fadeOut(500);
                    }
                });
                //当点击跳转链接后，回到页面顶部位置
                $("#return_top").click(function(){
                    // 此处加入finish防止多次点击回顶部或者回底部多次触发动画的bug,也可以使用stop()来替换finish()
                    $("html,body").stop().animate({"scrollTop":"0px"},1500);
                });
            });
        </script>
        <script type="text/javascript">

            //配置参数
            var appid = 'wxbb9a70d10651829b',
                appsercet = 'f6c32350257a1fdcb4eccaf33ff22cb4',
                mobile = '15736736889',
                timestamp=Math.round(new Date().getTime()/1000),
                nonce = MathRand(),
                bucket = 'yuhal-picture',
                video = document.getElementById('video'),
                canvas = document.getElementById('canvas'),
                context = canvas.getContext('2d'),
                fcount = 0,
                //人脸识别开关 本地调试设置true
                face = false,
                face = getCookie('face'),
                mediaStreamTrack,
                authentication,
                accesstoken,
                uid,
                sign;

            //请求地址
            var sign_url = 'https://api.yuhal.com/v1/sign/index',
                token_url = 'https://api.yuhal.com/v1/token/token',
                authentication_url = 'https://api.yuhal.com/v1/authentication/index',
                put_buck_url = 'https://api.yuhal.com/v2/bucket/yuhal-temp',
                bucket_url = 'https://api.yuhal.com/v2/bucket/'+bucket,
                face_url = 'https://api.yuhal.com/v2/face';

            $(function(){   
                var mobile_flag = isMobile(); // true为手机端，false为PC端
                if(mobile_flag){
                    loadMessage('Mobile Web not supported');
                    return false;
                }

                //获取签名
                $.ajax({
                    type: "GET",
                    url: sign_url,
                    dataType: "json",
                    data: {
                        appid:appid,
                        appsercet:appsercet,
                        mobile:mobile,
                        timestamp:timestamp,
                        nonce:nonce
                    },
                    async : false,
                    success: function(data){
                        // console.log(data);
                        if(data.code==200){
                            sign = data.data.info;
                        }else{
                            console.log('签名错误!');
                        }
                    },
                    error: function(data){
                        loadMessage(data.info)
                    }
                });

                //获取token
                $.ajax({
                    type: "POST",
                    url: token_url,
                    dataType: "json",
                    data: {
                        appid:appid,
                        mobile:mobile,
                        timestamp:timestamp,
                        nonce:nonce,
                        sign:sign,
                    },
                    async : false,
                    success: function(data){
                        // console.log(data);
                        if(data.code==200){
                            accesstoken = data.data.access_token;
                            uid = data.data.client.uid;
                        }else{
                            console.log('token错误!');
                        }
                    },
                    error: function(data){
                        loadMessage(data.info)
                    }
                });

                //获取authentication
                $.ajax({
                    type: "GET",
                    url: authentication_url,
                    dataType: "json",
                    data: {
                        appid:appid,
                        uid:uid,
                        accesstoken:accesstoken,
                    },
                    async : false,
                    success: function(data){
                        // console.log(data);
                        if(data.code==200){
                            authentication = data.data.authentication;
                        }else{
                            console.log('身份验证错误!');
                        }
                    },
                    error: function(data){
                        loadMessage(data.info)
                    }
                });

                //判断人脸识别存入的cookie信息是否存在
                //不存在 则继续进行人脸识别
                //存在 则正常访问
                if(!face){
                    $('.container').hide();
                    // 实现人脸拍照并传向后台
                    if(navigator.mediaDevices.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.getUserMedia){
                        getUserMediaToPhoto({video:{width:480,height:320}},mediaSuccess,mediaError);
                    }else{
                        error();
                    }    
                }else{
                    $("#app").hide();
                    getBucketImage();
                }
                
            })

            //获取仓库下的图片
            function getBucketImage(init=false){
                //获取仓库下的图片
                $.ajax({
                    type: "GET",
                    url: bucket_url,
                    dataType: "json",
                    data: {
                        marker:'',
                        prefix:bucket,
                        // limit:100,
                        authentication:authentication,
                    },
                    async : false,
                    beforeSend: function(){
                        $('.container').show();
                        $('.gallery').hide();
                    },
                    success: function(data){
                        // console.log(data);
                        if(data.code==200){
                            var html = '';
                            if(data.data[0].items.length>0){
                                var sort = 0;
                                $.each(data.data[0].items, function(i, info){
                                    sort = i+1;
                                    href = 'https://picture.yuhal.com/'+info.key;
                                    html += '<li><a href="'+href+'" title="第'+sort+'张图片 '+info.key+'"><img src="'+href+'?imageMogr2/auto-orient/thumbnail/600x600!/interlace/1/blur/1x0/quality/30|imageslim"></a></li>';
                                });  
                                $('.gallery').append(html);  

                                var init_time = 500;
                                if(init){
                                    init_time = sort*6;
                                }
                                setTimeout(function () {
                                    LazyLoading();  
                                },init_time)
                            }else{
                                html = '<center>暂无图片!</center>';
                                $('.gallery').html(html);
                            }  
                        }else{
                            loadMessage(data.info)
                        }
                    },
                    error: function(data){
                        loadMessage(data.info)
                    }
                });
                
                baguetteBox.run('.baguetteBoxOne', {
                    animation: 'fadeIn',
                });
            }

            function getUserMediaToPhoto(constraints,mediaSuccess,mediaError) {
                if(navigator.mediaDevices.getUserMedia){
                    //最新标准API
                    navigator.mediaDevices.getUserMedia(constraints).then(mediaSuccess).catch(mediaError);
                }else if (navigator.webkitGetUserMedia) {
                    //webkit核心浏览器
                    navigator.webkitGetUserMedia(constraints,mediaSuccess,mediaError);
                }else if(navigator.mozGetUserMedia){
                    //firefox浏览器
                    navigator.mozGetUserMedia(constraints,mediaSuccess,mediaError);
                }else if(navigator.getUserMedia){
                    //旧版API
                    navigator.getUserMedia(constraints,mediaSuccess,mediaError);
                }else{
                    mediaError(mediaError);
                }
            }
            //获取媒体成功回调函数
            function mediaSuccess(stream){
                // 兼容webkit核心浏览器
                var CompatibleURL = window.URL || window.webkitURL;
                //将视频流转化为video的源
                try{
                  mediaStreamTrack = stream;
                  video.src = CompatibleURL.createObjectURL(stream);
                }catch(e){
                  video.srcObject = stream;
                }
                //将视频绘制到canvas上
                postFace()
            }
            //获取媒体失败回调函数
            function mediaError(error) {
                $("#app").hide();
                loadMessage('Failed to access user media')
                return false;
            }
            function postFace() {
                setTimeout(function () {
                    context.drawImage(video,0,0,480,320);
                    img=canvas.toDataURL('image/jpg')
                    // 获取完整的base64编码,将照片以base64用ajax传到后台
                    $.post({
                        url:put_buck_url,
                        data:{
                            uri:img,
                            authentication:authentication,
                            _method:'put'
                        },
                        success:function (callback) {
                            callback = $.parseJSON(callback)
                            if(callback.code==200){
                                //得到上传图片去做比对
                                faceCheck(callback.data.fileName)
                                fcount++;
                            }
                        },
                        error:function (callback) {
                            postFace()
                        }
                    })
                },300)
            }
            function faceCheck(uri){
                $.get({
                    url:face_url,
                    data:{
                        uri:'http://pwydkeqx9.bkt.clouddn.com/'+uri,
                        authentication:authentication
                    },
                    success:function (callback) {
                        callback = $.parseJSON(callback)
                        if(callback.code==200){
                            var score = callback.data.info
                            if(score>=70){
                                //关闭摄像头
                                mediaStreamTrack.getTracks()[0].stop(); 
                                $("#app").hide();
                                getBucketImage(true);
                                setCookie('face',true);
                            }else if(fcount<=3){
                                postFace()
                            }else{
                                //关闭摄像头
                                mediaStreamTrack.getTracks()[0].stop();
                                $("#app").hide();
                                loadMessage('Failed to face recognition');
                            }
                        }else{
                            //关闭摄像头
                            mediaStreamTrack.getTracks()[0].stop();
                            $("#app").hide();
                            loadMessage('Failed to face recognition');
                        }
                    },
                    error:function (callback) {
                        postFace()
                    }
                })
            }

            //生成随机数
            function MathRand() 
            { 
                var Num=""; 
                for(var i=0;i<6;i++) 
                { 
                Num+=Math.floor(Math.random()*10); 
                } 
                return Num;
            }

            //懒加载
            function LazyLoading(){
                new AnimOnScroll(document.getElementById('gallery'), {
                    minDuration: 0.4,
                    maxDuration: 0.7,
                    viewportFactor: 0.2
                }); 
                $('.gallery').show();
                $('.container').hide();
            }

            //获取媒体失败回调函数
            function loadMessage(message) {
                $(".loading").text(message);
                $('.container').show();
                return false;
            }

            //写cookies，7天过期 
            function setCookie(name, value) { 
                return $.cookie(name, value, { expires: 7 });
            }

            //读取cookies 
            function getCookie(name) { 
                return $.cookie(name);
            }

            //判断访问类型是电脑还是手机
            function isMobile() {
                var userAgentInfo = navigator.userAgent;
                var mobileAgents = [ "Android", "iPhone", "SymbianOS", "Windows Phone", "iPad","iPod"];
                var mobile_flag = false;
                //根据userAgent判断是否是手机
                for (var v = 0; v < mobileAgents.length; v++) {
                    if (userAgentInfo.indexOf(mobileAgents[v]) > 0) {
                        mobile_flag = true;
                        break;
                    }
                }
                var screen_width = window.screen.width;
                var screen_height = window.screen.height;    
                //根据屏幕分辨率判断是否是手机
                if(screen_width < 500 && screen_height < 800){
                    mobile_flag = true;
                }
                return mobile_flag;
            }
           
        </script>
    </body>
</html>